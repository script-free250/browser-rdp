name: Browser RDP (Fixed)

on: workflow_dispatch

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Download Chrome Remote Desktop
      run: |
        Invoke-WebRequest https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi -OutFile crd.msi

    - name: Install Chrome Remote Desktop
      run: |
        Start-Process msiexec.exe -ArgumentList '/i crd.msi /qn' -Wait

    - name: Activate RDP Session
      env:
        # هذه الخطوة هي التي تحل المشكلة
        # نقوم بتخزين الكود السري في متغير بيئي لكي لا يفسده الباورشيل
        GOOGLE_CODE: ${{ secrets.CRD_CODE }}
      shell: powershell
      run: |
        # استدعاء الكود من المتغير البيئي بأمان
        $commandString = $env:GOOGLE_CODE
        
        # إضافة الرقم السري (PIN) للأمر
        # نستخدم مسافة قبل الشرطة للتأكد من صحة الأمر
        $finalCommand = "$commandString -pin=123456"
        
        # تنفيذ الأمر النهائي
        Invoke-Expression $finalCommand

    - name: Keep Alive
      run: |
        Write-Host "==================================================="
        Write-Host "Success! Go to: https://remotedesktop.google.com/access"
        Write-Host "PIN Code: 123456"
        Write-Host "==================================================="
        while ($true) {
          Start-Sleep -Seconds 60
        }
